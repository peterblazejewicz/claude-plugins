name: PowerShell Lint

on:
  pull_request:
    paths:
      - '**/*.ps1'
      - 'PSScriptAnalyzerSettings.psd1'
  workflow_dispatch:

jobs:
  lint:
    name: PSScriptAnalyzer
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser -SkipPublisherCheck

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          $settingsPath = './PSScriptAnalyzerSettings.psd1'

          if (-not (Test-Path $settingsPath)) {
              Write-Host "ERROR: Settings file not found at $settingsPath"
              exit 1
          }

          Write-Host "Running PSScriptAnalyzer with settings from: $settingsPath"
          Write-Host ""

          # Scan only PowerShell script files, excluding settings/config files
          $results = Get-ChildItem -Path . -Include '*.ps1' -Recurse |
              ForEach-Object { Invoke-ScriptAnalyzer -Path $_.FullName -Settings $settingsPath }

          if ($results) {
              Write-Host "PSScriptAnalyzer found issues:"
              Write-Host ""
              $results | Format-Table -Property RuleName, Severity, ScriptName, Line, Message -AutoSize -Wrap
              Write-Host ""
              Write-Host "Total issues: $(@($results).Count)"
              exit 1
          }
          else {
              Write-Host "PSScriptAnalyzer: No issues found"
          }
